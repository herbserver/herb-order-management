<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìç Verification Department - Herb On Naturals</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css">
</head>

<body class="bg-gray-50">
    <!-- Navigation Header -->
    <nav class="bg-white shadow-md border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center gap-3">
                    <img src="logo.png" alt="Logo" class="h-10 w-10 object-contain">
                    <div>
                        <h1 class="text-lg font-bold text-gray-800">üìç Verification Department</h1>
                        <p class="text-xs text-gray-500" id="userInfo">Loading...</p>
                    </div>
                </div>
                <button onclick="logout()"
                    class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition text-sm font-semibold">
                    üö™ Logout
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-2xl font-bold mb-4">üìç Verification Department</h2>
            <div id="deptOrdersList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <p class="text-gray-600">Loading orders...</p>
            </div>
        </div>
    </div>

    <!-- Order Detail Modal -->
    <div id="orderDetailModal"
        class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden shadow-2xl">
            <div id="orderDetailContent" class="overflow-y-auto max-h-[90vh]">
                <!-- Content will be dynamically loaded -->
            </div>
        </div>
    </div>

    <script src="js/common.js"></script>
    <script src="app.js"></script>
    <script>
        // Check authentication
        const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
        if (!currentUser || currentUser.type !== 'verification') {
            alert('Please login as Verification Department');
            window.location.href = 'index.html';
        } else {
            document.getElementById('userInfo').textContent = `Logged in: ${currentUser.name || currentUser.deptId || 'Verification'}`;

            // Set global variables for department logic
            window.currentDeptType = 'verification';
            window.currentUserType = 'department';

            // Load orders directly
            async function loadVerificationOrders() {
                try {
                    const res = await fetch(`${API_URL}/orders`);
                    const data = await res.json();

                    let orders = data.orders || [];
                    const container = document.getElementById('deptOrdersList');

                    // Filter for verification pending orders
                    orders = orders.filter(o => o.status === 'Verification Pending');
                    orders.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

                    if (orders.length === 0) {
                        container.innerHTML = '<p class="text-gray-500 text-center col-span-full py-8">No orders pending verification</p>';
                        return;
                    }

                    // Render verification cards
                    container.innerHTML = orders.map(o => `
                        <div class="bg-white border rounded-xl p-4 hover:shadow-lg transition-all">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded font-bold">New</span>
                                        <button onclick="sendWhatsAppDirect('booked', ${JSON.stringify(o).replace(/"/g, '&quot;')})" 
                                            class="w-6 h-6 bg-green-500 text-white rounded-full flex items-center justify-center hover:bg-green-600 hover:scale-110 shadow-sm transition-all" title="Send WhatsApp">
                                            ${WHATSAPP_ICON}
                                        </button>
                                    </div>
                                    <h4 class="font-bold text-lg text-gray-800 mt-1">${o.customerName}</h4>
                                    <p class="text-xs text-gray-500">${new Date(o.timestamp).toLocaleString()}</p>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold text-xl text-emerald-600">‚Çπ${o.total}</p>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-600 mb-3 space-y-1">
                                <p>üìç ${o.address}</p>
                                <p>üìû ${o.telNo}</p>
                            </div>
                            
                            <div class="mb-3">
                                <textarea id="remark-${o.orderId}" placeholder="Add remark..." class="w-full text-sm p-2 border rounded-lg h-20">${o.remark || ''}</textarea>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="saveOrderRemark('${o.orderId}')" class="bg-gray-100 text-gray-700 font-bold py-2 rounded-lg hover:bg-gray-200">Save Remark</button>
                                <button onclick="viewOrder('${o.orderId}')" class="bg-blue-50 text-blue-600 font-bold py-2 rounded-lg hover:bg-blue-100">View Details</button>
                            </div>
                            <div class="grid grid-cols-2 gap-2 mt-2">
                                <button onclick="verifyAddress('${o.orderId}')" class="bg-green-500 text-white font-bold py-2 rounded-lg hover:bg-green-600">‚úÖ Approve</button>
                                <button onclick="cancelOrder('${o.orderId}')" class="bg-red-50 text-red-500 font-bold py-2 rounded-lg hover:bg-red-100">‚ùå Cancel</button>
                            </div>
                        </div>
                    `).join('');
                } catch (e) {
                    console.error('Error loading orders:', e);
                    document.getElementById('deptOrdersList').innerHTML = '<p class="text-red-500 col-span-full">Error loading orders. Please refresh.</p>';
                }
            }

            // Define verification functions
            window.verifyAddress = async function (orderId) {
                if (!confirm('Mark this order as Verified?')) return;
                try {
                    const res = await fetch(`${API_URL}/orders/${orderId}/verify`, { method: 'POST' });
                    const data = await res.json();
                    if (data.success) {
                        showSuccessPopup('Verified', 'Order marked as Verified', '‚úÖ', '#10b981');
                        loadVerificationOrders();
                    } else alert(data.message);
                } catch (e) { alert(e.message); }
            };

            window.cancelOrder = async function (orderId) {
                const reason = prompt("Enter cancellation reason:");
                if (!reason) return;
                try {
                    const res = await fetch(`${API_URL}/orders/${orderId}/cancel`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ reason, cancelledBy: currentUser.id })
                    });
                    const data = await res.json();
                    if (data.success) {
                        showSuccessPopup('Cancelled', 'Order cancelled successfully', 'üõë', '#ef4444');
                        loadVerificationOrders();
                    }
                } catch (e) { alert(e.message); }
            };

            window.saveOrderRemark = async function (orderId) {
                const val = document.getElementById(`remark-${orderId}`).value;
                try {
                    await fetch(`${API_URL}/orders/${orderId}/remark`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ remark: val, remarkBy: currentUser.id })
                    });
                    showSuccessPopup('Saved', 'Remark updated', 'üìù', '#F59E0B');
                } catch (e) { alert(e.message); }
            };

            // Load orders on page load
            loadVerificationOrders();
        }

        function logout() {
            if (confirm('Logout karna chahte hain?')) {
                localStorage.removeItem('currentUser');
                window.location.href = 'index.html';
            }
        }
    </script>
</body>

</html>