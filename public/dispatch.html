<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“¦ Dispatch Department - Herb On Naturals</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css">
</head>

<body class="bg-gray-50">
    <!-- Navigation Header -->
    <nav class="bg-white shadow-md border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center gap-3">
                    <img src="logo.png" alt="Logo" class="h-10 w-10 object-contain">
                    <div>
                        <h1 class="text-lg font-bold text-gray-800">ğŸ“¦ Dispatch Department</h1>
                        <p class="text-xs text-gray-500" id="userInfo">Loading...</p>
                    </div>
                </div>
                <button onclick="logout()"
                    class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition text-sm font-semibold">
                    ğŸšª Logout
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-2xl font-bold mb-4">ğŸ“¦ Dispatch Department</h2>
            <div id="deptOrdersList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <p class="text-gray-600">Loading orders...</p>
            </div>
        </div>
    </div>

    <!-- Order Detail Modal -->
    <div id="orderDetailModal"
        class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden shadow-2xl">
            <div id="orderDetailContent" class="overflow-y-auto max-h-[90vh]">
                <!-- Content will be dynamically loaded -->
            </div>
        </div>
    </div>

    <script src="js/common.js"></script>
    <script src="app.js?v=20251233"></script>
    <script>
        // Check authentication
        const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
        if (!currentUser || currentUser.type !== 'dispatch') {
            alert('Please login as Dispatch Department');
            window.location.href = 'index.html';
        } else {
            document.getElementById('userInfo').textContent = `Logged in: ${currentUser.name || currentUser.deptId || 'Dispatch'}`;

            // Set global variables
            window.currentDeptType = 'dispatch';
            window.currentUserType = 'department';

            // Load dispatch orders
            async function loadDispatchOrders() {
                try {
                    const res = await fetch(`${API_URL}/orders`);
                    const data = await res.json();

                    let orders = data.orders || [];
                    const container = document.getElementById('deptOrdersList');

                    // Filter for verified orders (ready for dispatch)
                    orders = orders.filter(o => o.status === 'Verified');
                    orders.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

                    if (orders.length === 0) {
                        container.innerHTML = '<p class="text-gray-500 text-center col-span-full py-8">No orders ready for dispatch</p>';
                        return;
                    }

                    // Render dispatch cards
                    container.innerHTML = orders.map(o => `
                        <div class="bg-white border rounded-xl p-4 hover:shadow-lg transition-all">
                            <div class="flex justify-between items-center mb-4">
                                <div class="flex items-center gap-3">
                                    <h4 class="font-bold">${o.customerName}</h4>
                                    <button onclick="sendWhatsAppDirect('booked', ${JSON.stringify(o).replace(/"/g, '&quot;')})" 
                                        class="w-6 h-6 bg-green-500 text-white rounded-full flex items-center justify-center hover:bg-green-600 hover:scale-110 shadow-sm transition-all" title="Send WhatsApp">
                                        ${WHATSAPP_ICON}
                                    </button>
                                </div>
                                <span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold">Verified</span>
                            </div>
                            <p class="text-sm text-gray-600 mb-2">ğŸ“ ${o.address}</p>
                            <p class="text-sm text-gray-600 mb-4">ğŸ“ ${o.telNo}</p>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="viewOrder('${o.orderId}')" class="bg-blue-50 text-blue-600 font-bold py-2 rounded-lg hover:bg-blue-100">View Details</button>
                                <button onclick="alert('Shiprocket dispatch coming soon!')" class="w-full bg-orange-500 text-white font-bold py-2 rounded-xl hover:bg-orange-600 transition-all shadow-lg shadow-orange-200">
                                    ğŸš€ Dispatch
                                </button>
                            </div>
                        </div>
                    `).join('');
                } catch (e) {
                    console.error('Error loading orders:', e);
                    document.getElementById('deptOrdersList').innerHTML = '<p class="text-red-500 col-span-full">Error loading orders. Please refresh.</p>';
                }
            }

            // Load orders on page load
            loadDispatchOrders();
        }

        function logout() {
            if (confirm('Logout karna chahte hain?')) {
                localStorage.removeItem('currentUser');
                window.location.href = 'index.html';
            }
        }
    </script>
</body>

</html>