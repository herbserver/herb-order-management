<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Management Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        * {
            font-family: 'Poppins', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 50%, #dfe4ea 100%);
            min-height: 100vh;
        }

        .tab-active {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
    </style>
</head>

<body class="p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">üõ°Ô∏è Admin Panel</h1>
                    <p class="text-gray-500 mt-1">Employee & Order Management</p>
                </div>
                <button onclick="window.location.href='/'"
                    class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg font-semibold">
                    ‚Üê Back to Login
                </button>
            </div>
        </div>

        <!-- Tabs -->
        <div class="bg-white rounded-2xl shadow-lg p-2 mb-6 flex gap-2">
            <button onclick="switchTab('employees')" id="tab-employees"
                class="flex-1 px-6 py-3 rounded-xl font-bold transition-all tab-active">
                üë§ Employees
            </button>
            <button onclick="switchTab('orders')" id="tab-orders"
                class="flex-1 px-6 py-3 rounded-xl font-bold transition-all bg-gray-100 text-gray-600">
                üì¶ Orders
            </button>
        </div>

        <!-- Employees Tab -->
        <div id="employees-tab" class="">
            <!-- Search -->
            <div class="bg-white rounded-2xl shadow-lg p-4 mb-6">
                <input type="text" id="searchEmployee" placeholder="üîç Search by Name or ID..."
                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-emerald-500 outline-none"
                    oninput="filterEmployees(this.value)">
            </div>

            <!-- Employee List -->
            <div id="employeeList" class="space-y-4">
                <!-- Employees will be loaded here -->
            </div>
        </div>

        <!-- Orders Tab -->
        <div id="orders-tab" class="hidden">
            <!-- Search -->
            <div class="bg-white rounded-2xl shadow-lg p-4 mb-6">
                <input type="text" id="searchOrder" placeholder="üîç Search by Order ID or Customer..."
                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 outline-none"
                    oninput="filterOrders(this.value)">
            </div>

            <!-- Order Stats -->
            <div id="orderStats" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6"></div>

            <!-- Order List -->
            <div id="orderList" class="space-y-4">
                <!-- Orders will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Employee Modals (Password Reset & Edit) - Same as before -->
    <div id="resetModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4">
            <h2 class="text-2xl font-bold mb-4">üîë Reset Password</h2>
            <p class="text-gray-600 mb-4">Employee: <span id="resetEmpName" class="font-bold text-emerald-600"></span>
            </p>
            <p class="text-gray-600 mb-4">ID: <span id="resetEmpId" class="font-mono font-bold"></span></p>
            <input type="password" id="newPassword" placeholder="New Password (min 6 chars)"
                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl mb-4 focus:border-emerald-500 outline-none">
            <input type="password" id="confirmPassword" placeholder="Confirm Password"
                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl mb-6 focus:border-emerald-500 outline-none">
            <div class="flex gap-3">
                <button onclick="closeResetModal()"
                    class="flex-1 bg-gray-200 hover:bg-gray-300 px-4 py-3 rounded-xl font-bold">
                    Cancel
                </button>
                <button onclick="resetPassword()"
                    class="flex-1 bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-3 rounded-xl font-bold">
                    Reset Password
                </button>
            </div>
        </div>
    </div>

    <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4">
            <h2 class="text-2xl font-bold mb-4">‚úèÔ∏è Edit Employee</h2>
            <p class="text-gray-600 mb-4">Current ID: <span id="editCurrentId"
                    class="font-mono font-bold text-blue-600"></span></p>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Employee Name</label>
            <input type="text" id="editName" placeholder="Employee Name"
                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl mb-4 focus:border-blue-500 outline-none">
            <label class="block text-sm font-semibold text-gray-700 mb-2">Employee ID</label>
            <input type="text" id="editNewId" placeholder="New Employee ID (Optional)"
                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl mb-2 focus:border-blue-500 outline-none">
            <p class="text-xs text-gray-500 mb-6">‚ö†Ô∏è Changing ID will update all associated orders</p>
            <div class="flex gap-3">
                <button onclick="closeEditModal()"
                    class="flex-1 bg-gray-200 hover:bg-gray-300 px-4 py-3 rounded-xl font-bold">
                    Cancel
                </button>
                <button onclick="updateEmployee()"
                    class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded-xl font-bold">
                    Update
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        let allEmployees = [];
        let allOrders = [];
        let currentResetEmpId = null;
        let currentEditEmpId = null;

        // Initialize
        switchTab('employees');

        function switchTab(tab) {
            // Update tab buttons
            document.getElementById('tab-employees').classList.remove('tab-active');
            document.getElementById('tab-employees').classList.add('bg-gray-100', 'text-gray-600');
            document.getElementById('tab-orders').classList.remove('tab-active');
            document.getElementById('tab-orders').classList.add('bg-gray-100', 'text-gray-600');

            // Show/hide content
            document.getElementById('employees-tab').classList.add('hidden');
            document.getElementById('orders-tab').classList.add('hidden');

            if (tab === 'employees') {
                document.getElementById('tab-employees').classList.add('tab-active');
                document.getElementById('tab-employees').classList.remove('bg-gray-100', 'text-gray-600');
                document.getElementById('employees-tab').classList.remove('hidden');
                loadEmployees();
            } else {
                document.getElementById('tab-orders').classList.add('tab-active');
                document.getElementById('tab-orders').classList.remove('bg-gray-100', 'text-gray-600');
                document.getElementById('orders-tab').classList.remove('hidden');
                loadOrders();
            }
        }

        // ==================== EMPLOYEES ====================
        async function loadEmployees() {
            try {
                const res = await fetch(`${API_URL}/api/employees`);
                const data = await res.json();

                if (data.success) {
                    allEmployees = data.employees;
                    displayEmployees(allEmployees);
                } else {
                    alert('Failed to load employees');
                }
            } catch (error) {
                console.error('Error loading employees:', error);
                alert('Error loading employees: ' + error.message);
            }
        }

        function displayEmployees(employees) {
            const container = document.getElementById('employeeList');

            if (employees.length === 0) {
                container.innerHTML = `
                    <div class="bg-white rounded-2xl p-8 text-center">
                        <p class="text-gray-500">No employees found</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = employees.map(emp => `
                <div class="bg-white rounded-2xl shadow-lg p-6 hover:shadow-xl transition-shadow">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <h3 class="text-xl font-bold text-gray-800">${emp.name}</h3>
                                <span class="bg-emerald-100 text-emerald-700 px-3 py-1 rounded-full text-sm font-bold">${emp.id}</span>
                            </div>
                            <p class="text-gray-500 text-sm mb-4">Created: ${new Date(emp.createdAt).toLocaleDateString()}</p>
                            
                            <!-- Order Stats -->
                            <div class="grid grid-cols-2 md:grid-cols-5 gap-2 mt-4">
                                <div class="bg-gray-50 rounded-lg p-3 text-center">
                                    <p class="text-2xl font-bold text-gray-800">${emp.totalOrders}</p>
                                    <p class="text-xs text-gray-500">Total</p>
                                </div>
                                <div class="bg-red-50 rounded-lg p-3 text-center">
                                    <p class="text-2xl font-bold text-red-600">${emp.pendingOrders}</p>
                                    <p class="text-xs text-gray-500">Pending</p>
                                </div>
                                <div class="bg-blue-50 rounded-lg p-3 text-center">
                                    <p class="text-2xl font-bold text-blue-600">${emp.verifiedOrders}</p>
                                    <p class="text-xs text-gray-500">Verified</p>
                                </div>
                                <div class="bg-purple-50 rounded-lg p-3 text-center">
                                    <p class="text-2xl font-bold text-purple-600">${emp.dispatchedOrders}</p>
                                    <p class="text-xs text-gray-500">Dispatched</p>
                                </div>
                                <div class="bg-green-50 rounded-lg p-3 text-center">
                                    <p class="text-2xl font-bold text-green-600">${emp.deliveredOrders}</p>
                                    <p class="text-xs text-gray-500">Delivered</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Actions -->
                        <div class="ml-4 flex flex-col gap-2">
                            <button onclick="openEditModal('${emp.id}', '${emp.name}')" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-sm whitespace-nowrap">
                                ‚úèÔ∏è Edit
                            </button>
                            <button onclick="openResetModal('${emp.id}', '${emp.name}')" 
                                    class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-bold text-sm whitespace-nowrap">
                                üîë Reset Pass
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function filterEmployees(query) {
            if (!query.trim()) {
                displayEmployees(allEmployees);
                return;
            }

            const filtered = allEmployees.filter(emp =>
                emp.name.toLowerCase().includes(query.toLowerCase()) ||
                emp.id.toLowerCase().includes(query.toLowerCase())
            );

            displayEmployees(filtered);
        }

        // Employee modal functions (same as before)
        function openResetModal(empId, empName) {
            currentResetEmpId = empId;
            document.getElementById('resetEmpName').textContent = empName;
            document.getElementById('resetEmpId').textContent = empId;
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            document.getElementById('resetModal').classList.remove('hidden');
        }

        function closeResetModal() {
            document.getElementById('resetModal').classList.add('hidden');
            currentResetEmpId = null;
        }

        async function resetPassword() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!newPassword || !confirmPassword) return alert('Please fill both password fields');
            if (newPassword.length < 6) return alert('Password must be at least 6 characters long');
            if (newPassword !== confirmPassword) return alert('Passwords do not match!');

            try {
                const res = await fetch(`${API_URL}/api/reset-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ employeeId: currentResetEmpId, newPassword })
                });

                const data = await res.json();
                if (data.success) {
                    alert('‚úÖ Password reset successful!');
                    closeResetModal();
                } else {
                    alert('‚ùå ' + (data.message || 'Password reset failed'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function openEditModal(empId, empName) {
            currentEditEmpId = empId;
            document.getElementById('editCurrentId').textContent = empId;
            document.getElementById('editName').value = empName;
            document.getElementById('editNewId').value = '';
            document.getElementById('editModal').classList.remove('hidden');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            currentEditEmpId = null;
        }

        async function updateEmployee() {
            const newName = document.getElementById('editName').value.trim();
            const newId = document.getElementById('editNewId').value.trim();

            if (!newName && !newId) return alert('Please provide at least name or new ID');

            try {
                const res = await fetch(`${API_URL}/api/employees/${currentEditEmpId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: newName || undefined, newId: newId || undefined })
                });

                const data = await res.json();
                if (data.success) {
                    alert('‚úÖ ' + data.message);
                    closeEditModal();
                    loadEmployees();
                } else {
                    alert('‚ùå ' + (data.message || 'Update failed'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // ==================== ORDERS ====================
        async function loadOrders() {
            try {
                const res = await fetch(`${API_URL}/api/orders`);
                const data = await res.json();

                if (data.success) {
                    allOrders = data.orders;
                    displayOrderStats(allOrders);
                    displayOrders(allOrders);
                } else {
                    alert('Failed to load orders');
                }
            } catch (error) {
                console.error('Error loading orders', error);
                alert('Error loading orders: ' + error.message);
            }
        }

        function displayOrderStats(orders) {
            const stats = {
                total: orders.length,
                pending: orders.filter(o => o.status === 'Pending').length,
                verified: orders.filter(o => o.status === 'Address Verified').length,
                dispatched: orders.filter(o => o.status === 'Dispatched').length,
                delivered: orders.filter(o => o.status === 'Delivered').length
            };

            document.getElementById('orderStats').innerHTML = `
                <div class="bg-white rounded-xl p-4 shadow">
                    <p class="text-3xl font-bold text-gray-800">${stats.total}</p>
                    <p class="text-sm text-gray-500">Total Orders</p>
                </div>
                <div class="bg-red-50 rounded-xl p-4 shadow">
                    <p class="text-3xl font-bold text-red-600">${stats.pending}</p>
                    <p class="text-sm text-gray-500">Pending</p>
                </div>
                <div class="bg-blue-50 rounded-xl p-4 shadow">
                    <p class="text-3xl font-bold text-blue-600">${stats.verified}</p>
                    <p class="text-sm text-gray-500">Verified</p>
                </div>
                <div class="bg-purple-50 rounded-xl p-4 shadow">
                    <p class="text-3xl font-bold text-purple-600">${stats.dispatched}</p>
                    <p class="text-sm text-gray-500">Dispatched</p>
                </div>
                <div class="bg-green-50 rounded-xl p-4 shadow">
                    <p class="text-3xl font-bold text-green-600">${stats.delivered}</p>
                    <p class="text-sm text-gray-500">Delivered</p>
                </div>
            `;
        }

        function displayOrders(orders) {
            const container = document.getElementById('orderList');

            if (orders.length === 0) {
                container.innerHTML = '<div class="bg-white rounded-2xl p-8 text-center"><p class="text-gray-500">No orders found</p></div>';
                return;
            }

            container.innerHTML = orders.map(order => {
                const statusColors = {
                    'Pending': 'bg-red-100 text-red-700',
                    'Address Verified': 'bg-blue-100 text-blue-700',
                    'Dispatched': 'bg-purple-100 text-purple-700',
                    'Delivered': 'bg-green-100 text-green-700'
                };

                return `
                    <div class="bg-white rounded-xl shadow p-4">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <h3 class="text-lg font-bold">${order.orderId}</h3>
                                    <span class="px-3 py-1 rounded-full text-sm font-bold ${statusColors[order.status] || 'bg-gray-100 text-gray-700'}">${order.status}</span>
                                </div>
                                <p class="text-gray-600 text-sm"><strong>Customer:</strong> ${order.customerName}</p>
                                <p class="text-gray-600 text-sm"><strong>Employee:</strong> ${order.employee} (${order.employeeId})</p>
                                <p class="text-gray-600 text-sm flex items-center gap-2">
                                    <strong>Mobile:</strong> ${order.telNo}
                                    <button onclick="window.open('https://wa.me/91${order.telNo}?text=' + encodeURIComponent('‡§®‡§Æ‡§∏‡•ç‡§§‡•á ${order.customerName}! üôè\\n\\nüåø *Herb On Naturals* ‡§Æ‡•á‡§Ç ‡§Ü‡§™‡§ï‡§æ ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§π‡•à‡•§\\n\\n‚úÖ ‡§Ü‡§™‡§ï‡§æ Order successfully book ‡§π‡•ã ‡§ó‡§Ø‡§æ ‡§π‡•à!\\nüì¶ *Order ID: ${order.orderId}*\\nüí∞ *Total Amount: ‚Çπ${order.total}*\\n\\n‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶!'), '_blank')" 
                                        class="w-5 h-5 bg-green-500 text-white rounded-full flex items-center justify-center hover:bg-green-600 transition-all shadow-sm" title="Send WhatsApp">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" style="width:1em; height:1em;"><path fill="currentColor" d="M380.9 97.1C339 55.1 283.2 32 223.9 32c-122.4 0-222 99.6-222 222 0 39.1 10.2 77.3 29.6 111L0 480l117.7-30.9c32.4 17.7 68.9 27 106.1 27h.1c122.3 0 224.1-99.6 224.1-222 0-59.3-25.2-115-67.1-157zm-157 341.6c-33.1 0-65.6-8.9-94-25.7l-6.7-4-69.8 18.3L72 359.2l-4.4-7c-18.5-29.4-28.2-63.3-28.2-98.2 0-101.7 82.8-184.5 184.6-184.5 49.3 0 95.6 19.2 130.4 54.1 34.8 34.9 56.2 81.2 56.1 130.5 0 101.8-84.9 184.6-186.6 184.6zm101.2-138.2c-5.5-2.8-32.8-16.2-37.9-18-5.1-1.9-8.8-2.8-12.5 2.8-3.7 5.6-14.3 18-17.6 21.8-3.2 3.7-6.5 4.2-12 1.4-5.5-2.8-23.2-8.5-44.2-27.1-16.4-14.6-27.4-32.7-30.6-38.1-3.2-5.4-.3-8.3 2.4-11.1 2.4-2.5 5.5-6.4 8.3-9.6 2.8-3.2 3.7-5.5 5.5-9.1 1.9-3.7 1-6.9-.5-9.7-1.4-2.8-12.5-30.1-17.1-41.2-4.5-10.8-9.1-9.3-12.5-9.5-3.2-.2-6.9-.2-10.6-.2-3.7 0-9.7 1.4-14.8 6.9-5.1 5.6-19.4 19-19.4 46.3 0 27.3 19.9 53.7 22.6 57.4 2.8 3.7 39.1 59.7 94.8 83.8 13.2 5.8 23.5 9.2 31.5 11.8 13.3 4.2 25.4 3.6 35 2.2 10.7-1.5 32.8-13.4 37.4-26.4 4.6-13 4.6-24.1 3.2-26.4-1.3-2.5-5-3.9-10.5-6.6z"/></svg>
                                    </button>
                                </p>
                                <p class="text-gray-600 text-sm"><strong>Amount:</strong> ‚Çπ${order.total}</p>
                                <p class="text-gray-500 text-xs mt-2">${new Date(order.timestamp).toLocaleString()}</p>
                            </div>
                            <button onclick="deleteOrder('${order.orderId}')" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-bold text-sm">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterOrders(query) {
            if (!query.trim()) {
                displayOrders(allOrders);
                return;
            }

            const filtered = allOrders.filter(order =>
                order.orderId.toLowerCase().includes(query.toLowerCase()) ||
                order.customerName.toLowerCase().includes(query.toLowerCase()) ||
                order.telNo.includes(query)
            );

            displayOrders(filtered);
        }

        async function deleteOrder(orderId) {
            if (!confirm(`Are you sure you want to DELETE order ${orderId}?\n\nThis action cannot be undone!`)) {
                return;
            }

            try {
                const res = await fetch(`${API_URL}/api/orders/${orderId}`, {
                    method: 'DELETE'
                });

                const data = await res.json();

                if (data.success) {
                    alert('‚úÖ Order deleted successfully!');
                    loadOrders(); // Reload list
                } else {
                    alert('‚ùå ' + (data.message || 'Delete failed'));
                }
            } catch (error) {
                console.error('Error deleting order:', error);
                alert('Error: ' + error.message);
            }
        }

        // Close modals on escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeResetModal();
                closeEditModal();
            }
        });
    </script>
</body>

</html>